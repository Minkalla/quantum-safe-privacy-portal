
> portal-backend@0.2.0 test:unit:pqc:services
> jest test/unit/pqc/services --testTimeout=30000

(node:13743) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
(node:13744) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
[31m[Nest] 13743  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mML-KEM-768 encryption failed for keyId test-key:[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mError: Encryption failed[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mEncryption failed: Encryption failed[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mML-DSA-65 signing failed for dataHash 44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a:[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mTypeError: Cannot read properties of undefined (reading 'success')[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mSignature generation failed: Cannot read properties of undefined (reading 'success')[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mML-KEM-768 decryption failed for keyId test-key:[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mError: Decryption failed[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mDecryption failed: Decryption failed[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mDecryption failed: Invalid encrypted data format[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mML-DSA-65 signing failed for dataHash 44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a:[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mError: Signature generation failed[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mSignature generation failed: Signature generation failed[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mML-DSA-65 verification failed for dataHash 44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a:[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mTypeError: Cannot read properties of undefined (reading 'success')[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mPQC signing failed: Integrity creation failed[39m
[31m[Nest] 13744  - [39m06/30/2025, 12:30:20 AM [31m  ERROR[39m [38;5;3m[PQCDataValidationService] [39m[31mData integrity creation failed: Integrity creation failed[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:21 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mML-KEM-768 encryption failed for keyId test-key:[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:21 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mError: Service unavailable[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:21 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mEncryption failed: Service unavailable[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:21 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mML-KEM-768 encryption failed for keyId test-key:[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:21 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mTypeError: Cannot read properties of undefined (reading 'success')[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:21 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mEncryption failed: Cannot read properties of undefined (reading 'success')[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:21 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mML-KEM-768 encryption failed for keyId pqc-key-1751243421017-95bada712f266eb1:[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:21 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mTypeError: Cannot read properties of undefined (reading 'success')[39m
[31m[Nest] 13743  - [39m06/30/2025, 12:30:21 AM [31m  ERROR[39m [38;5;3m[PQCDataEncryptionService] [39m[31mEncryption failed: Cannot read properties of undefined (reading 'success')[39m
FAIL test/unit/pqc/services/pqc-data-validation.test.ts
  â— PQCDataValidationService Unit Tests â€º generateSignature â€º should generate classical signatures as fallback

    TypeError: Cannot read properties of undefined (reading 'success')

      241 |       });
      242 |
    > 243 |       if (pqcResult.success && pqcResult.token) {
          |                     ^
      244 |         this.logger.debug('ML-DSA-65 signature completed');
      245 |         return `dilithium3:${pqcResult.token}`;
      246 |       } else {

      at PQCDataValidationService.signWithDilithium (src/services/pqc-data-validation.service.ts:243:21)
      at PQCDataValidationService.generateSignature (src/services/pqc-data-validation.service.ts:42:21)
      at Object.<anonymous> (test/unit/pqc/services/pqc-data-validation.test.ts:61:22)

  â— PQCDataValidationService Unit Tests â€º verifySignature â€º should reject signatures with data hash mismatch

    expect(received).toContain(expected) // indexOf

    Expected value: "Data hash mismatch"
    Received array: ["Invalid signature"]

      157 |
      158 |       expect(result.isValid).toBe(false);
    > 159 |       expect(result.errors).toContain('Data hash mismatch');
          |                             ^
      160 |     });
      161 |
      162 |     it('should handle expired signatures', async () => {

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-validation.test.ts:159:29)

  â— PQCDataValidationService Unit Tests â€º verifySignature â€º should track performance metrics

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      197 |
      198 |       expect(result.performanceMetrics).toBeDefined();
    > 199 |       expect(result.performanceMetrics?.validationTime).toBeGreaterThan(0);
          |                                                         ^
      200 |       expect(result.performanceMetrics?.memoryUsage).toBeGreaterThan(0);
      201 |     });
      202 |   });

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-validation.test.ts:199:57)

  â— PQCDataValidationService Unit Tests â€º validateDataIntegrity â€º should validate data integrity successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      277 |       const result = await service.validateDataIntegrity(testData, integrity);
      278 |
    > 279 |       expect(result.isValid).toBe(true);
          |                              ^
      280 |       expect(result.errors).toHaveLength(0);
      281 |     });
      282 |

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-validation.test.ts:279:30)

  â— PQCDataValidationService Unit Tests â€º batchValidateIntegrity â€º should handle partial failures in batch validation

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      400 |
      401 |       expect(results).toHaveLength(2);
    > 402 |       expect(results[0].isValid).toBe(true);
          |                                  ^
      403 |       expect(results[1].isValid).toBe(false);
      404 |     });
      405 |   });

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-validation.test.ts:402:34)

FAIL test/unit/pqc/services/pqc-data-encryption.test.ts
  â— PQCDataEncryptionService Unit Tests â€º decryptData â€º should decrypt Kyber-768 encrypted data

    expect(received).toBe(expected) // Object.is equality

    Expected: "original plaintext data"
    Received: {"decrypted": true, "keyId": "test-key"}

      148 |       expect(result.success).toBe(true);
      149 |       if (result.success) {
    > 150 |         expect(result.decryptedData).toBe('original plaintext data');
          |                                      ^
      151 |       }
      152 |     });
      153 |

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-encryption.test.ts:150:38)

  â— PQCDataEncryptionService Unit Tests â€º decryptData â€º should validate encrypted field structure

    expect(received).toContain(expected) // indexOf

    Expected substring: "Invalid encrypted field"
    Received string:    "Invalid encrypted data format"

      184 |
      185 |       expect(result.success).toBe(false);
    > 186 |       expect(result.error).toContain('Invalid encrypted field');
          |                            ^
      187 |     });
      188 |   });
      189 |

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-encryption.test.ts:186:28)

  â— PQCDataEncryptionService Unit Tests â€º batchEncryptData â€º should encrypt multiple data items

    TypeError: service.batchEncryptData is not a function

      202 |       );
      203 |
    > 204 |       const results = await service.batchEncryptData(dataItems, {
          |                                     ^
      205 |         algorithm: PQCAlgorithmType.KYBER_768,
      206 |         keyId: 'batch-key',
      207 |       });

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-encryption.test.ts:204:37)

  â— PQCDataEncryptionService Unit Tests â€º batchEncryptData â€º should handle partial failures in batch encryption

    TypeError: service.batchEncryptData is not a function

      233 |         });
      234 |
    > 235 |       const results = await service.batchEncryptData(dataItems, {
          |                                     ^
      236 |         algorithm: PQCAlgorithmType.KYBER_768,
      237 |         keyId: 'batch-key',
      238 |       });

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-encryption.test.ts:235:37)

  â— PQCDataEncryptionService Unit Tests â€º Error Handling â€º should handle invalid input data

    expect(received).toContain(expected) // indexOf

    Expected substring: "Invalid input data"
    Received string:    "Cannot read properties of undefined (reading 'success')"

      307 |
      308 |       expect(result.success).toBe(false);
    > 309 |       expect(result.error).toContain('Invalid input data');
          |                            ^
      310 |     });
      311 |
      312 |     it('should handle missing key ID', async () => {

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-encryption.test.ts:309:28)

  â— PQCDataEncryptionService Unit Tests â€º Error Handling â€º should handle missing key ID

    expect(received).toContain(expected) // indexOf

    Expected substring: "Key ID is required"
    Received string:    "Cannot read properties of undefined (reading 'success')"

      317 |
      318 |       expect(result.success).toBe(false);
    > 319 |       expect(result.error).toContain('Key ID is required');
          |                            ^
      320 |     });
      321 |   });
      322 | });

      at Object.<anonymous> (test/unit/pqc/services/pqc-data-encryption.test.ts:319:28)

-------------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------
File                                 | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                        
-------------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------
All files                            |    9.93 |    43.78 |   15.62 |    9.93 |                                                                                                                                                          
 src                                 |       0 |        0 |       0 |       0 |                                                                                                                                                          
  app.module.ts                      |       0 |        0 |       0 |       0 | 1-86                                                                                                                                                     
  main.ts                            |       0 |        0 |       0 |       0 | 1-230                                                                                                                                                    
 src/auth                            |    5.58 |        0 |       0 |    5.58 |                                                                                                                                                          
  auth.controller.ts                 |       0 |        0 |       0 |       0 | 1-342                                                                                                                                                    
  auth.module.ts                     |       0 |        0 |       0 |       0 | 1-37                                                                                                                                                     
  auth.service.ts                    |   20.87 |        0 |       0 |   20.87 | 39-43,52-75,78-106,114-157,164-261,267-299,309-363                                                                                                       
  enhanced-auth.service.ts           |       0 |        0 |       0 |       0 | 1-567                                                                                                                                                    
  jwt-auth.guard.ts                  |       0 |        0 |       0 |       0 | 1-51                                                                                                                                                     
 src/auth/dto                        |       0 |        0 |       0 |       0 |                                                                                                                                                          
  login.dto.ts                       |       0 |        0 |       0 |       0 | 1-52                                                                                                                                                     
  pqc-auth.dto.ts                    |       0 |        0 |       0 |       0 | 1-97                                                                                                                                                     
  register.dto.ts                    |       0 |        0 |       0 |       0 | 1-43                                                                                                                                                     
 src/auth/interfaces                 |       0 |        0 |       0 |       0 |                                                                                                                                                          
  pqc-auth.interface.ts              |       0 |        0 |       0 |       0 | 1-89                                                                                                                                                     
 src/consent                         |       0 |        0 |       0 |       0 |                                                                                                                                                          
  consent.controller.ts              |       0 |        0 |       0 |       0 | 1-177                                                                                                                                                    
  consent.module.ts                  |       0 |        0 |       0 |       0 | 1-33                                                                                                                                                     
  consent.service.ts                 |       0 |        0 |       0 |       0 | 1-91                                                                                                                                                     
 src/consent/dto                     |       0 |        0 |       0 |       0 |                                                                                                                                                          
  create-consent.dto.ts              |       0 |        0 |       0 |       0 | 1-75                                                                                                                                                     
  get-consent.dto.ts                 |       0 |        0 |       0 |       0 | 1-22                                                                                                                                                     
 src/controllers                     |       0 |        0 |       0 |       0 |                                                                                                                                                          
  pqc-consent.controller.ts          |       0 |        0 |       0 |       0 | 1-181                                                                                                                                                    
  pqc-data.controller.ts             |       0 |        0 |       0 |       0 | 1-44                                                                                                                                                     
  pqc-performance.controller.ts      |       0 |        0 |       0 |       0 | 1-96                                                                                                                                                     
  pqc-user.controller.ts             |       0 |        0 |       0 |       0 | 1-124                                                                                                                                                    
 src/dto                             |       0 |        0 |       0 |       0 |                                                                                                                                                          
  pqc-api.dto.ts                     |       0 |        0 |       0 |       0 | 1-85                                                                                                                                                     
  pqc-data.dto.ts                    |       0 |        0 |       0 |       0 | 1-52                                                                                                                                                     
 src/guards                          |       0 |        0 |       0 |       0 |                                                                                                                                                          
  pqc-api.guard.ts                   |       0 |        0 |       0 |       0 | 1-84                                                                                                                                                     
 src/interceptors                    |       0 |        0 |       0 |       0 |                                                                                                                                                          
  performance-monitor.interceptor.ts |       0 |        0 |       0 |       0 | 1-39                                                                                                                                                     
 src/jwt                             |   30.28 |        0 |       0 |   30.28 |                                                                                                                                                          
  jwt.module.ts                      |       0 |        0 |       0 |       0 | 1-33                                                                                                                                                     
  jwt.service.ts                     |      36 |        0 |       0 |      36 | 36-44,48-64,75-92,95-105,108-137,148-174                                                                                                                 
 src/middleware                      |       0 |        0 |       0 |       0 |                                                                                                                                                          
  data-integrity.middleware.ts       |       0 |        0 |       0 |       0 | 1-44                                                                                                                                                     
  pqc-api.middleware.ts              |       0 |        0 |       0 |       0 | 1-109                                                                                                                                                    
 src/models                          |       0 |        0 |       0 |       0 |                                                                                                                                                          
  Consent.ts                         |       0 |        0 |       0 |       0 | 1-200                                                                                                                                                    
  User.ts                            |       0 |        0 |       0 |       0 | 1-213                                                                                                                                                    
 src/models/interfaces               |     100 |      100 |     100 |     100 |                                                                                                                                                          
  pqc-data.interface.ts              |     100 |      100 |     100 |     100 |                                                                                                                                                          
 src/modules                         |       0 |        0 |       0 |       0 |                                                                                                                                                          
  pqc-api.module.ts                  |       0 |        0 |       0 |       0 | 1-18                                                                                                                                                     
 src/monitoring                      |       0 |        0 |       0 |       0 |                                                                                                                                                          
  alerting.service.ts                |       0 |        0 |       0 |       0 | 1-53                                                                                                                                                     
  anomaly-detector.service.ts        |       0 |        0 |       0 |       0 | 1-101                                                                                                                                                    
  audit-trail.service.ts             |       0 |        0 |       0 |       0 | 1-102                                                                                                                                                    
  baseline-manager.service.ts        |       0 |        0 |       0 |       0 | 1-303                                                                                                                                                    
  monitoring.module.ts               |       0 |        0 |       0 |       0 | 1-24                                                                                                                                                     
  performance-gates.service.ts       |       0 |        0 |       0 |       0 | 1-83                                                                                                                                                     
 src/pqc                             |    9.83 |       10 |       0 |    9.83 |                                                                                                                                                          
  ab-testing-integration.service.ts  |       0 |        0 |       0 |       0 | 1-137                                                                                                                                                    
  ab-testing.module.ts               |       0 |        0 |       0 |       0 | 1-23                                                                                                                                                     
  ab-testing.service.ts              |       0 |        0 |       0 |       0 | 1-117                                                                                                                                                    
  metrics-collector.service.ts       |       0 |        0 |       0 |       0 | 1-152                                                                                                                                                    
  pqc-feature-flags.module.ts        |       0 |        0 |       0 |       0 | 1-12                                                                                                                                                     
  pqc-feature-flags.service.ts       |   34.48 |       50 |       0 |   34.48 | 52-53,56-70,73-85,88-109,112-127,130-138,141-157,160-173,176-188,191-202                                                                                 
  pqc-monitoring.service.ts          |   20.48 |        0 |       0 |   20.48 | 29-42,45-55,58-78,81-101,104-117,120-138,141-154,157-172,175-176,179-180,183-184,187-188,191-192,195-212,215-228,231-239,242-248,251-268,271-302,305-326 
  pqc-rollback-test.service.ts       |       0 |        0 |       0 |       0 | 1-237                                                                                                                                                    
  rollback-system.service.ts         |       0 |        0 |       0 |       0 | 1-185                                                                                                                                                    
 src/pqc-data                        |       0 |        0 |       0 |       0 |                                                                                                                                                          
  pqc-data.module.ts                 |       0 |        0 |       0 |       0 | 1-77                                                                                                                                                     
 src/quality                         |       0 |        0 |       0 |       0 |                                                                                                                                                          
  documentation-validator.service.ts |       0 |        0 |       0 |       0 | 1-132                                                                                                                                                    
  quality.module.ts                  |       0 |        0 |       0 |       0 | 1-8                                                                                                                                                      
 src/repositories                    |       0 |        0 |       0 |       0 |                                                                                                                                                          
  base-pqc.repository.ts             |       0 |        0 |       0 |       0 | 1-52                                                                                                                                                     
  consent-pqc.repository.ts          |       0 |        0 |       0 |       0 | 1-69                                                                                                                                                     
 src/secrets                         |      36 |        0 |       0 |      36 |                                                                                                                                                          
  secrets.module.ts                  |       0 |        0 |       0 |       0 | 1-26                                                                                                                                                     
  secrets.service.ts                 |   45.45 |        0 |       0 |   45.45 | 35-50,61-98                                                                                                                                              
 src/services                        |   20.73 |    67.28 |   58.82 |   20.73 |                                                                                                                                                          
  api-performance.service.ts         |       0 |        0 |       0 |       0 | 1-128                                                                                                                                                    
  bulk-encryption.service.ts         |       0 |        0 |       0 |       0 | 1-126                                                                                                                                                    
  circuit-breaker.service.ts         |       0 |        0 |       0 |       0 | 1-211                                                                                                                                                    
  classical-crypto.service.ts        |       0 |        0 |       0 |       0 | 1-301                                                                                                                                                    
  crypto-services.module.ts          |       0 |        0 |       0 |       0 | 1-40                                                                                                                                                     
  data-access-performance.service.ts |       0 |        0 |       0 |       0 | 1-30                                                                                                                                                     
  data-migration.service.ts          |       0 |        0 |       0 |       0 | 1-517                                                                                                                                                    
  field-encryption.service.ts        |       0 |        0 |       0 |       0 | 1-186                                                                                                                                                    
  hybrid-crypto.service.ts           |       0 |        0 |       0 |       0 | 1-241                                                                                                                                                    
  integrity-checker.service.ts       |       0 |        0 |       0 |       0 | 1-24                                                                                                                                                     
  pqc-data-encryption.service.ts     |   90.17 |    71.42 |      80 |   90.17 | 100,177,195-199,216-223,226-233                                                                                                                          
  pqc-data-validation.service.ts     |   81.37 |     75.8 |   85.71 |   81.37 | 44-45,78-80,111-114,118-136,210-211,215-218,231-233,256-261,268-269,282-284,312-319,336-344                                                              
 src/user                            |       0 |        0 |       0 |       0 |                                                                                                                                                          
  user.module.ts                     |       0 |        0 |       0 |       0 | 1-32                                                                                                                                                     
-------------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------
Test Suites: 2 failed, 2 total
Tests:       11 failed, 21 passed, 32 total
Snapshots:   0 total
Time:        2.384 s, estimated 3 s
Ran all test suites matching /test\/unit\/pqc\/services/i.
